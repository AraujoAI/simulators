<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Simulator Builder</title>
    <style>
        :root {
            --primary: #2563eb;
            --success: #16a34a;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --border: #e2e8f0;
            --text: #1e293b;
        }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            padding: 40px;
            display: flex;
            justify-content: center;
        }
        .container {
            width: 100%;
            max-width: 1100px;
            background: var(--card-bg);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        h1 { margin-top: 0; text-align: center; color: var(--text); }
        p.subtitle { text-align: center; color: #64748b; margin-bottom: 40px; }
        
        /* Step Row Grid */
        .step-row {
            display: grid;
            grid-template-columns: 40px 1.2fr 2fr 1.5fr;
            gap: 20px;
            padding: 20px;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 15px;
            background: #fff;
            align-items: center;
        }
        .step-row:hover { border-color: var(--primary); background: #feffff; }
        
        .step-num { font-weight: bold; font-size: 18px; color: #cbd5e1; }
        
        label { display: block; font-size: 11px; font-weight: 700; color: #64748b; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 13px;
            box-sizing: border-box;
        }
        input[type="file"] { font-size: 12px; }

        .btn-tune {
            background: #3b82f6; color: white; border: none; padding: 10px;
            border-radius: 6px; cursor: pointer; font-size: 13px; width: 100%;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: background 0.2s, opacity 0.2s;
            opacity: 0.5; cursor: not-allowed;
        }
        .btn-tune.enabled { opacity: 1; cursor: pointer; }
        .btn-tune.enabled:hover { background: #2563eb; }
        .btn-tune svg { width: 16px; height: 16px; }

        /* DOWNLOAD SECTION */
        .download-section {
            margin-top: 40px;
            padding: 30px;
            background: #f1f5f9;
            border-radius: 12px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            align-items: start;
        }

        .action-group label { margin-bottom: 8px; display:block; }

        .btn-action {
            display: block; width: 100%; padding: 15px;
            border: none; border-radius: 8px; font-size: 16px; font-weight: bold;
            cursor: pointer; transition: all 0.2s; opacity: 0.5; pointer-events: none;
        }
        .btn-action.active { opacity: 1; pointer-events: all; }

        .btn-draft { background: var(--primary); color: white; }
        .btn-draft:hover { background: #1d4ed8; }

        .btn-final { background: var(--success); color: white; }
        .btn-final:hover { background: #15803d; }

        /* Disabled input style */
        input:disabled { background: #e2e8f0; cursor: not-allowed; opacity: 0.7; }

        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            background: #e2e8f0;
            color: #64748b;
            margin-top: 5px;
        }
        .status-badge.uploaded { background: #dcfce7; color: #166534; }

        /* MODAL STYLES */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.9); backdrop-filter: blur(4px);
        }
        .modal-content {
            position: relative; margin: 2vh auto; width: 95%; height: 95vh;
            background: #1e293b; border-radius: 8px; overflow: hidden; display: flex;
        }
        .editor-canvas-area {
            flex-grow: 1; background: #0f172a; position: relative;
            display: flex; align-items: center; justify-content: center; overflow: hidden;
            user-select: none; /* Prevent selection while dragging */
        }
        .editor-img {
            max-width: 100%; max-height: 100%; object-fit: contain;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            display: block;
            pointer-events: none; /* Let clicks pass to wrapper if needed, or handle on wrapper */
        }
        
        .hotspot-wrapper {
            position: absolute; pointer-events: none; 
        }

        .editor-hotspot {
            position: absolute; 
            border: 2px solid #00ff00; 
            background: rgba(0, 255, 0, 0.2);
            box-shadow: 0 0 10px rgba(0,255,0,0.5); 
            cursor: move; /* Indicates draggable */
            pointer-events: auto;
        }
        .editor-hotspot:active {
            /* cursor: grabbing; - handled by JS specifically for move vs resize */
            background: rgba(0, 255, 0, 0.3);
        }

        /* RESIZE HANDLES */
        .resize-handle {
            position: absolute;
            width: 10px; height: 10px;
            background: #00ff00;
            border: 1px solid white;
            z-index: 10;
        }
        .handle-nw { top: -6px; left: -6px; cursor: nw-resize; }
        .handle-n { top: -6px; left: 50%; margin-left: -6px; cursor: n-resize; }
        .handle-ne { top: -6px; right: -6px; cursor: ne-resize; }
        .handle-w { top: 50%; left: -6px; margin-top: -6px; cursor: w-resize; }
        .handle-e { top: 50%; right: -6px; margin-top: -6px; cursor: e-resize; }
        .handle-sw { bottom: -6px; left: -6px; cursor: sw-resize; }
        .handle-s { bottom: -6px; left: 50%; margin-left: -6px; cursor: s-resize; }
        .handle-se { bottom: -6px; right: -6px; cursor: se-resize; }
        
        .editor-sidebar {
            width: 300px; background: #1e293b; padding: 20px; color: white;
            border-left: 1px solid #334155; display: flex; flex-direction: column; gap: 20px;
        }
        .control-group { background: #334155; padding: 15px; border-radius: 8px; }
        .control-title { font-size: 12px; font-weight: bold; color: #94a3b8; margin-bottom: 10px; text-transform: uppercase; }
        .d-pad { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; margin-bottom: 10px; }
        .d-btn {
            background: #475569; border: none; color: white; padding: 8px; border-radius: 4px;
            cursor: pointer; font-weight: bold; transition: background 0.1s;
        }
        .d-btn:hover { background: #64748b; }
        .d-btn:active { background: #2563eb; }
        .d-btn.center { visibility: hidden; }

        .val-display { text-align: center; font-family: monospace; font-size: 14px; margin-bottom: 5px; color: #38bdf8; }

        .btn-close {
            margin-top: auto; padding: 15px; background: #22c55e; color: white; border: none;
            border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 16px;
        }
        .btn-close:hover { background: #16a34a; }

    </style>
</head>
<body>

<div class="container">
    <h1>Universal Simulator Builder</h1>
    <p class="subtitle">Upload images and set instructions first, then use "Tune & Preview" to set hotspots.</p>

    <form id="builder-form">
        <div id="steps-container"></div>
    </form>

    <div class="download-section">
        <div class="action-group">
            <label>STEP 1: REVIEW</label>
            <button id="btn-draft" class="btn-action btn-draft" onclick="downloadDraft()">Download Draft Simulator</button>
            <div style="font-size:11px; color:#64748b; margin-top:5px;">(Includes visible green hotspots)</div>
        </div>

        <div class="action-group">
            <label>STEP 2: NAME FILE</label>
            <input type="text" id="file-name" placeholder="MySimulator" disabled oninput="validateFileName()">
            <div style="font-size:11px; color:#64748b; margin-top:5px;">(No spaces allowed)</div>
        </div>

        <div class="action-group">
            <label>STEP 3: FINALIZE</label>
            <button id="btn-final" class="btn-action btn-final" onclick="downloadFinal()">Download Final Simulator</button>
            <div style="font-size:11px; color:#64748b; margin-top:5px;">(Clean UI, invisible hotspots)</div>
        </div>
    </div>
</div>

<!-- EDITOR MODAL -->
<div id="editor-modal" class="modal">
    <div class="modal-content">
        <div class="editor-canvas-area" id="canvas-area">
            <img id="modal-img" class="editor-img" src="" onload="syncOverlay()">
            <div id="overlay-wrapper" class="hotspot-wrapper">
                <div id="modal-hotspot" class="editor-hotspot">
                    <!-- Resize Handles -->
                    <div class="resize-handle handle-nw" data-dir="nw"></div>
                    <div class="resize-handle handle-n" data-dir="n"></div>
                    <div class="resize-handle handle-ne" data-dir="ne"></div>
                    <div class="resize-handle handle-w" data-dir="w"></div>
                    <div class="resize-handle handle-e" data-dir="e"></div>
                    <div class="resize-handle handle-sw" data-dir="sw"></div>
                    <div class="resize-handle handle-s" data-dir="s"></div>
                    <div class="resize-handle handle-se" data-dir="se"></div>
                </div>
            </div>
        </div>
        
        <div class="editor-sidebar">
            <h3 style="margin-top:0">Fine Tune Hotspot</h3>
            <p style="font-size:12px; color:#94a3b8; margin-bottom:20px;">Drag center to move. Drag handles to resize.</p>

            <div class="control-group">
                <div class="control-title">Position (Move Box)</div>
                <div class="val-display">Top: <span id="disp-t">0</span>% | Left: <span id="disp-l">0</span>%</div>
                <div class="d-pad">
                    <button type="button" class="d-btn center"></button>
                    <button type="button" class="d-btn" onclick="adjust('t', -0.5)">?</button>
                    <button type="button" class="d-btn center"></button>
                    
                    <button type="button" class="d-btn" onclick="adjust('l', -0.5)">?</button>
                    <button type="button" class="d-btn center"></button>
                    <button type="button" class="d-btn" onclick="adjust('l', 0.5)">?</button>

                    <button type="button" class="d-btn center"></button>
                    <button type="button" class="d-btn" onclick="adjust('t', 0.5)">?</button>
                    <button type="button" class="d-btn center"></button>
                </div>
            </div>

            <div class="control-group">
                <div class="control-title">Size (Adjust Border)</div>
                <div class="val-display">Width: <span id="disp-w">0</span>% | Height: <span id="disp-h">0</span>%</div>
                
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <div style="flex:1">
                        <div style="font-size:10px; text-align:center; margin-bottom:4px;">Width</div>
                        <div style="display:flex; gap:2px;">
                            <button type="button" class="d-btn" style="flex:1" onclick="adjust('w', -0.5)">-</button>
                            <button type="button" class="d-btn" style="flex:1" onclick="adjust('w', 0.5)">+</button>
                        </div>
                    </div>
                    <div style="flex:1">
                        <div style="font-size:10px; text-align:center; margin-bottom:4px;">Height</div>
                        <div style="display:flex; gap:2px;">
                            <button type="button" class="d-btn" style="flex:1" onclick="adjust('h', -0.5)">-</button>
                            <button type="button" class="d-btn" style="flex:1" onclick="adjust('h', 0.5)">+</button>
                        </div>
                    </div>
                </div>
            </div>

            <button type="button" class="btn-close" onclick="closeModal()">Done</button>
        </div>
    </div>
</div>

<script>
    const genericDefault = { t: 40, l: 40, w: 20, h: 20 };
    const defaultHotspots = new Array(10).fill(genericDefault);

    const imageStore = new Array(10).fill(null);
    const stepsContainer = document.getElementById('steps-container');
    
    // Global editor state
    let activeStepIndex = -1;
    let currentHotspot = { t:0, l:0, w:0, h:0 };

    // 1. Render Rows
    function renderRows() {
        let html = '';
        for (let i = 0; i < 10; i++) {
            const def = defaultHotspots[i] || { t:40, l:40, w:20, h:20 };
            html += `
            <div class="step-row">
                <div class="step-num">${i + 1}</div>
                <div>
                    <label>SCREENSHOT</label>
                    <input type="file" accept="image/*" onchange="handleUpload(this, ${i})">
                    <span id="badge-${i}" class="status-badge">Empty</span>
                </div>
                <div>
                    <label>INSTRUCTION TEXT: What is the user clicking or what is happening on screen</label>
                    <input type="text" id="text-${i}" placeholder="e.g. Click the File Menu..." oninput="checkStepReady(${i})">
                </div>
                <div>
                    <label>CLICK ZONE</label>
                    <button type="button" id="btn-tune-${i}" class="btn-tune" onclick="openModal(${i})" disabled>
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                        Tune & Preview
                    </button>
                    <!-- Hidden inputs to store values -->
                    <input type="hidden" id="t-${i}" value="${def.t}">
                    <input type="hidden" id="l-${i}" value="${def.l}">
                    <input type="hidden" id="w-${i}" value="${def.w}">
                    <input type="hidden" id="h-${i}" value="${def.h}">
                </div>
            </div>`;
        }
        stepsContainer.innerHTML = html;
    }

    // 2. Step Readiness Check
    window.checkStepReady = function(index) {
        const hasImage = !!imageStore[index];
        const hasText = document.getElementById(`text-${index}`).value.trim().length > 0;
        const btn = document.getElementById(`btn-tune-${index}`);
        
        if (hasImage && hasText) {
            btn.disabled = false;
            btn.classList.add("enabled");
        } else {
            btn.disabled = true;
            btn.classList.remove("enabled");
        }
        checkGlobalReady();
    };

    // 3. Handle Upload
    window.handleUpload = function(input, index) {
        const file = input.files[0];
        const badge = document.getElementById(`badge-${index}`);
        
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                imageStore[index] = e.target.result;
                badge.innerText = "Uploaded";
                badge.classList.add("uploaded");
                checkStepReady(index);
            };
            reader.readAsDataURL(file);
        } else {
            imageStore[index] = null;
            badge.innerText = "Empty";
            badge.classList.remove("uploaded");
            checkStepReady(index);
        }
    };

    function checkGlobalReady() {
        const hasImages = imageStore.some(img => img !== null);
        const btnDraft = document.getElementById('btn-draft');
        if (hasImages) btnDraft.classList.add('active');
        else btnDraft.classList.remove('active');
    }

    // 4. Modal Logic
    window.openModal = function(index) {
        if (!imageStore[index]) return;
        activeStepIndex = index;
        currentHotspot.t = parseFloat(document.getElementById(`t-${index}`).value);
        currentHotspot.l = parseFloat(document.getElementById(`l-${index}`).value);
        currentHotspot.w = parseFloat(document.getElementById(`w-${index}`).value);
        currentHotspot.h = parseFloat(document.getElementById(`h-${index}`).value);
        const img = document.getElementById('modal-img');
        img.src = imageStore[index];
        document.getElementById('editor-modal').style.display = 'block';
        setTimeout(syncOverlay, 50);
    };

    window.closeModal = function() {
        document.getElementById('editor-modal').style.display = 'none';
    };

    window.syncOverlay = function() {
        const img = document.getElementById('modal-img');
        const wrapper = document.getElementById('overlay-wrapper');
        const rect = img.getBoundingClientRect();
        const containerRect = document.getElementById('canvas-area').getBoundingClientRect();
        const top = rect.top - containerRect.top;
        const left = rect.left - containerRect.left;
        wrapper.style.top = top + "px"; wrapper.style.left = left + "px"; wrapper.style.width = rect.width + "px"; wrapper.style.height = rect.height + "px";
        updateModalUI();
    };
    window.addEventListener('resize', syncOverlay);

    // --- DRAG & RESIZE LOGIC ---
    const box = document.getElementById('modal-hotspot');
    let isDragging = false;
    let isResizing = false;
    let resizeDir = '';
    let startX, startY;
    let startL, startT, startW, startH;

    box.addEventListener('mousedown', function(e) {
        // Check if clicked on a handle
        if (e.target.classList.contains('resize-handle')) {
            isResizing = true;
            resizeDir = e.target.dataset.dir;
            e.stopPropagation(); // Don't trigger move
        } else {
            isDragging = true;
        }

        startX = e.clientX;
        startY = e.clientY;
        startL = currentHotspot.l;
        startT = currentHotspot.t;
        startW = currentHotspot.w;
        startH = currentHotspot.h;
        
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
        e.preventDefault(); 
    });

    function onMouseMove(e) {
        const wrapper = document.getElementById('overlay-wrapper');
        const rect = wrapper.getBoundingClientRect();
        if (rect.width === 0 || rect.height === 0) return;

        const dxPixels = e.clientX - startX;
        const dyPixels = e.clientY - startY;

        // Convert pixel delta to percentage
        const dpX = (dxPixels / rect.width) * 100;
        const dpY = (dyPixels / rect.height) * 100;

        if (isDragging) {
            let newL = startL + dpX;
            let newT = startT + dpY;

            // Clamp Position
            if (newL < 0) newL = 0;
            if (newT < 0) newT = 0;
            if (newL + startW > 100) newL = 100 - startW;
            if (newT + startH > 100) newT = 100 - startH;

            currentHotspot.l = parseFloat(newL.toFixed(1));
            currentHotspot.t = parseFloat(newT.toFixed(1));
        } else if (isResizing) {
            let newW = startW;
            let newH = startH;
            let newL = startL;
            let newT = startT;

            // Directions: N, S, E, W
            if (resizeDir.includes('e')) newW = startW + dpX;
            if (resizeDir.includes('s')) newH = startH + dpY;
            if (resizeDir.includes('w')) {
                newW = startW - dpX;
                newL = startL + dpX;
            }
            if (resizeDir.includes('n')) {
                newH = startH - dpY;
                newT = startT + dpY;
            }

            // Min size check (e.g. 1%)
            if (newW < 1) { newW = 1; if(resizeDir.includes('w')) newL = startL + startW - 1; }
            if (newH < 1) { newH = 1; if(resizeDir.includes('n')) newT = startT + startH - 1; }

            currentHotspot.w = parseFloat(newW.toFixed(1));
            currentHotspot.h = parseFloat(newH.toFixed(1));
            currentHotspot.l = parseFloat(newL.toFixed(1));
            currentHotspot.t = parseFloat(newT.toFixed(1));
        }

        updateModalUI();
        
        // Update Form inputs immediately
        document.getElementById(`l-${activeStepIndex}`).value = currentHotspot.l;
        document.getElementById(`t-${activeStepIndex}`).value = currentHotspot.t;
        document.getElementById(`w-${activeStepIndex}`).value = currentHotspot.w;
        document.getElementById(`h-${activeStepIndex}`).value = currentHotspot.h;
    }

    function onMouseUp() {
        isDragging = false;
        isResizing = false;
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
    }
    // --- END DRAG LOGIC ---

    window.adjust = function(prop, delta) {
        currentHotspot[prop] = parseFloat((currentHotspot[prop] + delta).toFixed(1));
        if (currentHotspot[prop] < 0) currentHotspot[prop] = 0;
        document.getElementById(`${prop}-${activeStepIndex}`).value = currentHotspot[prop];
        updateModalUI();
    };

    function updateModalUI() {
        const box = document.getElementById('modal-hotspot');
        box.style.top = currentHotspot.t + '%';
        box.style.left = currentHotspot.l + '%';
        box.style.width = currentHotspot.w + '%';
        box.style.height = currentHotspot.h + '%';
        document.getElementById('disp-t').innerText = currentHotspot.t;
        document.getElementById('disp-l').innerText = currentHotspot.l;
        document.getElementById('disp-w').innerText = currentHotspot.w;
        document.getElementById('disp-h').innerText = currentHotspot.h;
    }

    // 5. Download Logic
    window.downloadDraft = function() {
        generateSimulator(true, "Draft_Simulator.html");
        
        // Enable Step 2
        const input = document.getElementById('file-name');
        input.disabled = false;
        input.focus();
    };

    window.validateFileName = function() {
        const input = document.getElementById('file-name');
        input.value = input.value.replace(/\s/g, ''); // Remove spaces
        
        const btnFinal = document.getElementById('btn-final');
        if (input.value.length > 0) {
            btnFinal.classList.add('active');
        } else {
            btnFinal.classList.remove('active');
        }
    };

    window.downloadFinal = function() {
        const name = document.getElementById('file-name').value || "Final_Simulator";
        generateSimulator(false, name + ".html");
    };

    // 6. Generate Core
    window.generateSimulator = function(isDraft, filename) {
        const validSteps = [];
        for (let i = 0; i < 10; i++) {
            if (imageStore[i]) {
                validSteps.push({
                    id: i,
                    image: imageStore[i],
                    text: document.getElementById(`text-${i}`).value,
                    hotspot: {
                        t: document.getElementById(`t-${i}`).value,
                        l: document.getElementById(`l-${i}`).value,
                        w: document.getElementById(`w-${i}`).value,
                        h: document.getElementById(`h-${i}`).value
                    },
                    cursor: (i === 7) ? 'crosshair' : 'pointer',
                    isFinal: (i === 9)
                });
            }
        }
        if (validSteps.length > 0) validSteps[validSteps.length-1].isFinal = true;

        if (validSteps.length === 0) { alert("Upload at least 1 image"); return; }

        const template = buildTemplate(validSteps, isDraft);
        downloadFile(template, filename);
    };

    function downloadFile(content, filename) {
        const blob = new Blob([content], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function buildTemplate(stepsData, isDraft) {
        const stepsJSON = JSON.stringify(stepsData);
        
        // Conditional CSS based on Draft vs Final
        let hotspotCSS = '';
        if (isDraft) {
            hotspotCSS = `border: 3px solid #00ff00; background: rgba(0, 255, 0, 0.1); box-shadow: 0 0 10px rgba(0,255,0,0.5);`;
        } else {
            hotspotCSS = `border: none; background: transparent; box-shadow: none;`;
        }

        return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Simulation</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #222; display: flex; justify-content: center; align-items: center; font-family: 'Segoe UI', sans-serif; }
        
        #sim-container { 
            position: relative; 
            width: 100%; height: 100%;
            background: #222;
            display: flex; justify-content: center; align-items: center;
        }
        
        #sim-img { 
            max-width: 100%; max-height: 100%; 
            object-fit: contain; 
            display: block; user-select: none; 
        }
        
        #hotspot-layer { position: absolute; pointer-events: none; }
        
        /* Dynamic Hotspot */
        .hotspot { 
            position: absolute; cursor: pointer; z-index: 100; pointer-events: auto;
            ${hotspotCSS}
        }
        ${isDraft ? '.hotspot:hover { background: rgba(0, 255, 0, 0.2); }' : ''}
        
        .cursor-crosshair { cursor: crosshair !important; }
        
        #click-catcher { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; }
        
        /* Revised Reset Button Style */
        #reset-zone {
            position: fixed;
            top: 10px;
            left: 10px;
            width: 30px;
            height: 30px;
            background: #FFD700;
            border-radius: 50%;
            opacity: 0.3;
            cursor: pointer;
            z-index: 1000;
            transition: opacity 0.3s;
        }
        #reset-zone:hover {
            opacity: 1;
        }
        
        #instruction-bar { position: absolute; bottom: 0; left:0; width: 100%; background: rgba(0,0,0,0.8); color: white; padding: 15px; text-align: center; font-size: 18px; z-index: 150; }
        #feedback-box { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #e74c3c; color: white; padding: 15px 30px; border-radius: 6px; font-weight: bold; display: none; z-index: 300; pointer-events: none; border: 2px solid white; }
        #success-box { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #27ae60; color: white; padding: 20px 40px; border-radius: 8px; text-align: center; display: none; z-index: 300; }
    </style>
</head>
<body>
    <div id="sim-container">
        <img id="sim-img" src="" onload="syncLayer()">
        <div id="hotspot-layer">
            <div id="hotspot" class="hotspot" onclick="nextStep()"></div>
        </div>
        <div id="click-catcher" onclick="showError()"></div>
        <div id="reset-zone" onclick="resetSim()" title="Restart"></div>
        <div id="instruction-bar"></div>
        <div id="feedback-box">Incorrect area. Please try again.</div>
        <div id="success-box"><h2>Simulation Complete!</h2><p>Click top-left to restart.</p></div>
    </div>
    <script>
        const steps = ${stepsJSON};
        let currentStepIndex = 0;
        const imgEl = document.getElementById('sim-img');
        const layerEl = document.getElementById('hotspot-layer');
        const hotEl = document.getElementById('hotspot');
        const txtEl = document.getElementById('instruction-bar');
        const errEl = document.getElementById('feedback-box');
        const sucEl = document.getElementById('success-box');
        const catchEl = document.getElementById('click-catcher');

        function init() { loadStep(0); window.addEventListener('resize', syncLayer); }
        
        function syncLayer() {
            const rect = imgEl.getBoundingClientRect();
            layerEl.style.width = rect.width + 'px';
            layerEl.style.height = rect.height + 'px';
            layerEl.style.left = imgEl.offsetLeft + 'px';
            layerEl.style.top = imgEl.offsetTop + 'px';
        }

        function loadStep(index) {
            currentStepIndex = index;
            const stepData = steps[index];
            imgEl.src = stepData.image;
            txtEl.innerText = stepData.text || "";
            if (stepData.isFinal && index === steps.length - 1) {
                hotEl.style.display = 'none'; catchEl.style.display = 'none'; txtEl.style.display = 'none'; sucEl.style.display = 'block';
            } else {
                hotEl.style.display = 'block'; catchEl.style.display = 'block'; txtEl.style.display = 'block'; sucEl.style.display = 'none';
                hotEl.style.top = stepData.hotspot.t + '%';
                hotEl.style.left = stepData.hotspot.l + '%';
                hotEl.style.width = stepData.hotspot.w + '%';
                hotEl.style.height = stepData.hotspot.h + '%';
                if(stepData.cursor === 'crosshair') hotEl.classList.add('cursor-crosshair'); else hotEl.classList.remove('cursor-crosshair');
            }
        }
        function nextStep() { if (currentStepIndex < steps.length - 1) loadStep(currentStepIndex + 1); else { hotEl.style.display = 'none'; catchEl.style.display = 'none'; txtEl.style.display = 'none'; sucEl.style.display = 'block'; } }
        function showError() { errEl.style.display = 'block'; setTimeout(() => errEl.style.display = 'none', 1000); }
        function resetSim() { loadStep(0); }
        window.onload = init;
    <\/script>
</body>
</html>`;
    }

    renderRows();
</script>
</body>
</html>
